<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Pro - Stable Compression Full</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        :root { --primary: #2196F3; --accent: #ff5252; --bg: #121212; --card: #1e1e1e; --text: #eee; --checker: #333; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }
        .transparent-bg { background-color: #222; background-image: linear-gradient(45deg, var(--checker) 25%, transparent 25%), linear-gradient(-45deg, var(--checker) 25%, transparent 25%), linear-gradient(45deg, transparent 75%, var(--checker) 75%), linear-gradient(-45deg, transparent 75%, var(--checker) 75%); background-size: 8px 8px; }
        
        .screen { display: none; padding: 15px; box-sizing: border-box; min-height: 100vh; }
        .active { display: block; }

        /* ダッシュボード */
        .project-header { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; position: sticky; top: 10px; z-index: 10; }
        .stamp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; }
        .special-grid { border-bottom: 2px solid #444; padding-bottom: 15px; margin-bottom: 15px; }
        .stamp-card { background: var(--card); border-radius: 10px; padding: 8px; border: 1px solid #333; text-align: center; cursor: pointer; transition: 0.2s; }
        .stamp-card:active { transform: scale(0.95); background: #252525; }
        .stamp-card .thumb { width: 70px; height: 70px; margin: 0 auto 6px; border-radius: 4px; border: 1px solid #444; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .stamp-card .thumb img { max-width: 100%; max-height: 100%; }

        /* エディタ */
        .editor-header { position: sticky; top: 0; background: var(--bg); z-index: 100; padding: 10px 0; border-bottom: 2px solid #333; text-align: center; }
        #preview-area { margin: 0 auto 10px; border: 2px solid #444; border-radius: 8px; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #main-canvas { max-width: 100%; max-height: 100%; }
        #play-state-overlay { position: absolute; bottom: 5px; font-size: 10px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 10px; left: 50%; transform: translateX(-50%); }

        .btn-group { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; margin-top: 10px; padding: 0 5px; }
        button { padding: 10px 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 12px; transition: 0.2s; }
        button:active { opacity: 0.7; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: #00B900; color: white; }
        .btn-orange { background: #FF9800; color: white; }
        .btn-red { background: var(--accent); color: white; }
        .btn-gray { background: #444; color: white; }

        .frame-list-container { margin-top: 10px; }
        .frame-item { background: var(--card); padding: 8px; border-radius: 10px; display: flex; align-items: center; gap: 10px; margin-bottom: 8px; border: 1px solid #333; }
        .list-thumb { width: 50px; height: 50px; border-radius: 4px; overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border: 1px solid #444; }
        .list-thumb img { max-width: 100%; max-height: 100%; }
        .item-ctrls { display: flex; flex-direction: column; gap: 4px; margin-left: auto; }
        .btn-mini { padding: 4px 8px; font-size: 11px; }

        input[type="text"] { background: #000; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 6px; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="project-screen" class="screen active">
    <h2 style="margin-top:0;">Studio Pro</h2>
    <div class="project-header">
        <div style="margin-bottom:12px;">
            <label style="font-size:12px; color:#888;">プロジェクト名</label>
            <input type="text" id="project-name" value="my_stamp_project">
        </div>
        <div class="btn-group">
            <button class="btn-gray" onclick="exportBackupZip()">保存(Backup)</button>
            <button class="btn-gray" onclick="document.getElementById('load-zip').click()">復元(Restore)</button>
            <input type="file" id="load-zip" style="display:none" onchange="importProjectZip(this)">
            <button class="btn-green" style="flex-grow:1;" onclick="buildReleaseZip()">一括APNG生成 (ZIP)</button>
        </div>
    </div>
    
    <div style="font-size:12px; color:#888; margin-bottom:8px;">メイン・タブ画像</div>
    <div id="special-grid" class="stamp-grid special-grid"></div>
    
    <div style="font-size:12px; color:#888; margin-bottom:8px;">スタンプ (1〜24)</div>
    <div id="stamp-grid" class="stamp-grid"></div>
</div>

<div id="editor-screen" class="screen">
    <div class="editor-header">
        <button class="btn-gray" onclick="showDashboard()" style="position:absolute; left:10px; top:10px;">戻る</button>
        <h3 id="editing-id-label" style="margin:0 0 10px 0;">Stamp</h3>
        
        <div id="preview-area" class="transparent-bg" onclick="togglePreview()">
            <canvas id="main-canvas"></canvas>
            <div id="play-state-overlay">PAUSED</div>
        </div>

        <div class="btn-group">
            <button class="btn-blue" onclick="document.getElementById('bulk-upload').click()">一括読込</button>
            <button class="btn-green" id="fill-btn" onclick="smartFill()">パターン充填</button>
            <button class="btn-orange" onclick="exportSingleAPNG()">個別保存</button>
            <button class="btn-red" onclick="clearCurrentFrames()">消去</button>
            <input type="file" id="bulk-upload" multiple accept="image/*" style="display:none" onchange="handleBulkUpload(this)">
        </div>
    </div>
    <div id="frames-list" class="frame-list-container"></div>
</div>

<script>
    const CONFIG = {
        main: { w: 240, h: 240, maxF: 1, label: "Main" },
        tab: { w: 96, h: 74, maxF: 1, label: "Tab" },
        stamp: { w: 320, h: 270, maxF: 20, label: "Stamp" }
    };

    let project = { stamps: {} };
    let currentId = "01";
    let currentType = "stamp";
    let isPlaying = false;
    let previewTimer = null;
    const mainCanvas = document.getElementById('main-canvas');
    const mainCtx = mainCanvas.getContext('2d');

    // 初期化：24個のスタンプと特殊枠を作成
    function initProject() {
        const sg = document.getElementById('special-grid');
        sg.innerHTML = '';
        ['main', 'tab'].forEach(id => {
            if (!project.stamps[id]) project.stamps[id] = { delay: 200, buffers: new Array(1).fill(null) };
            renderCard(sg, id, CONFIG[id].label);
        });

        const g = document.getElementById('stamp-grid');
        g.innerHTML = '';
        for (let i = 1; i <= 24; i++) {
            const id = String(i).padStart(2, '0');
            if (!project.stamps[id]) project.stamps[id] = { delay: 100, buffers: new Array(20).fill(null) };
            renderCard(g, id, `#${id}`);
        }
    }

    function renderCard(container, id, label) {
        const card = document.createElement('div');
        card.className = 'stamp-card';
        card.onclick = () => openEditor(id);
        const buf = project.stamps[id].buffers[0];
        const type = (id === 'main' || id === 'tab') ? id : 'stamp';
        const thumbSrc = buf ? arrayBufferToDataURL(buf, type) : '';
        card.innerHTML = `
            <div class="thumb transparent-bg">${thumbSrc ? `<img src="${thumbSrc}">` : ''}</div>
            <div style="font-size:10px; color:#888;">${label}</div>
        `;
        container.appendChild(card);
    }

    function openEditor(id) {
        currentId = id;
        currentType = (id === 'main' || id === 'tab') ? id : 'stamp';
        const sData = project.stamps[id];
        
        document.getElementById('editing-id-label').innerText = CONFIG[currentType].label + (currentType === 'stamp' ? ` #${id}` : '');
        document.getElementById('fill-btn').style.display = currentType === 'stamp' ? 'inline-block' : 'none';

        // 表示サイズ調整
        mainCanvas.width = CONFIG[currentType].w;
        mainCanvas.height = CONFIG[currentType].h;
        const scale = currentType === 'tab' ? 1.5 : 0.6; // タブは小さすぎるので少し大きく表示
        document.getElementById('preview-area').style.width = (CONFIG[currentType].w * scale) + 'px';
        document.getElementById('preview-area').style.height = (CONFIG[currentType].h * scale) + 'px';

        document.getElementById('project-screen').classList.remove('active');
        document.getElementById('editor-screen').classList.add('active');
        renderEditorLists();
        updateStaticPreview();
    }

    function renderEditorLists() {
        const list = document.getElementById('frames-list');
        list.innerHTML = '';
        const sData = project.stamps[currentId];
        sData.buffers.forEach((buf, i) => {
            const thumbSrc = buf ? arrayBufferToDataURL(buf, currentType) : '';
            const div = document.createElement('div');
            div.className = 'frame-item';
            div.innerHTML = `
                <div style="font-size:12px; width:20px; color:#666;">${i+1}</div>
                <div class="list-thumb transparent-bg">${thumbSrc ? `<img src="${thumbSrc}">` : ''}</div>
                <div style="flex-grow:1"><input type="file" accept="image/*" onchange="loadSingle(${i}, this)" style="font-size:10px;"></div>
                <div class="item-ctrls">
                    <button class="btn-mini btn-red" onclick="deleteFrame(${i})">×</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // --- コアロジック：APNGエンコード (実績のある256色圧縮) ---
    function encodeApng(activeBuffers, width, height, delay) {
        // UPNG.encode: 第4引数に256を指定してパレット圧縮
        const apng = UPNG.encode(activeBuffers, width, height, 256, new Array(activeBuffers.length).fill(delay));
        const view = new DataView(apng);
        let offset = 8;
        while (offset < apng.byteLength) {
            const len = view.getUint32(offset);
            const type = view.getUint32(offset + 4);
            if (type === 0x6163544C) { // acTLチャンク：ループ設定
                view.setUint32(offset + 12, 1); // 1回再生
                break;
            }
            offset += 12 + len;
        }
        return apng;
    }

    // --- 出力機能 ---
    async function exportSingleAPNG() {
        const sData = project.stamps[currentId];
        const active = sData.buffers.filter(b => b !== null);
        if (active.length === 0) return alert("画像がありません");
        try {
            const apng = encodeApng(active, CONFIG[currentType].w, CONFIG[currentType].h, sData.delay);
            saveBlob(new Blob([apng], {type: 'image/png'}), `${currentId}.png`);
        } catch (e) { alert("失敗: " + e.message); }
    }

    async function buildReleaseZip() {
        const zip = new JSZip();
        for (let id in project.stamps) {
            const sData = project.stamps[id];
            const active = sData.buffers.filter(b => b !== null);
            if (active.length === 0) continue;
            const type = (id === 'main' || id === 'tab') ? id : 'stamp';
            const apng = encodeApng(active, CONFIG[type].w, CONFIG[type].h, sData.delay);
            zip.file(`${id}.png`, apng);
        }
        const blob = await zip.generateAsync({type:"blob"});
        saveBlob(blob, `RELEASE_${document.getElementById('project-name').value}.zip`);
    }

    // --- データ処理 ---
    async function loadSingle(i, input) {
        if (!input.files[0]) return;
        project.stamps[currentId].buffers[i] = await processImage(input.files[0], currentType);
        renderEditorLists(); updateStaticPreview();
    }

    async function handleBulkUpload(input) {
        const files = Array.from(input.files).sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true}));
        const sData = project.stamps[currentId];
        for (let i = 0; i < sData.buffers.length && i < files.length; i++) {
            sData.buffers[i] = await processImage(files[i], currentType);
        }
        renderEditorLists(); updateStaticPreview();
    }

    function processImage(file, type) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    cvs.width = CONFIG[type].w; cvs.height = CONFIG[type].h;
                    const c = cvs.getContext('2d');
                    const s = Math.min(cvs.width/img.width, cvs.height/img.height);
                    c.drawImage(img, (cvs.width-img.width*s)/2, (cvs.height-img.height*s)/2, img.width*s, img.height*s);
                    resolve(c.getImageData(0,0,cvs.width,cvs.height).data.buffer);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    function arrayBufferToDataURL(buf, type) {
        const cvs = document.createElement('canvas');
        cvs.width = CONFIG[type].w; cvs.height = CONFIG[type].h;
        cvs.getContext('2d').putImageData(new ImageData(new Uint8ClampedArray(buf), cvs.width, cvs.height), 0, 0);
        return cvs.toDataURL();
    }

    // --- UI操作 ---
    function togglePreview() {
        if (currentType !== 'stamp') return;
        isPlaying = !isPlaying;
        document.getElementById('play-state-overlay').innerText = isPlaying ? "PLAYING" : "PAUSED";
        if (isPlaying) {
            let activeIdxs = project.stamps[currentId].buffers.map((b,i)=> b?i:null).filter(v=>v!==null);
            if(activeIdxs.length === 0) return;
            let count = 0;
            previewTimer = setInterval(() => {
                updateStaticPreview(activeIdxs[count % activeIdxs.length]);
                count++;
            }, project.stamps[currentId].delay);
        } else { clearInterval(previewTimer); }
    }

    function updateStaticPreview(idx = null) {
        const bufs = project.stamps[currentId].buffers;
        const targetIdx = idx !== null ? idx : bufs.findIndex(b => b !== null);
        mainCtx.clearRect(0,0,mainCanvas.width,mainCanvas.height);
        if (targetIdx !== -1 && bufs[targetIdx]) {
            mainCtx.putImageData(new ImageData(new Uint8ClampedArray(bufs[targetIdx]), mainCanvas.width, mainCanvas.height), 0, 0);
        }
    }

    function showDashboard() {
        if(previewTimer) clearInterval(previewTimer); isPlaying = false;
        document.getElementById('editor-screen').classList.remove('active');
        document.getElementById('project-screen').classList.add('active');
        initProject();
    }

    function clearCurrentFrames() {
        if(confirm("この枠をリセットしますか？")) {
            project.stamps[currentId].buffers.fill(null);
            renderEditorLists(); updateStaticPreview();
        }
    }

    function deleteFrame(i) {
        project.stamps[currentId].buffers[i] = null;
        renderEditorLists(); updateStaticPreview();
    }

    function smartFill() {
        const bufs = project.stamps[currentId].buffers;
        const pattern = bufs.slice(1).filter(b => b !== null);
        if (pattern.length < 1) return alert("2枚目以降に画像を置いてください");
        for (let i = 1; i < 20; i++) if (!bufs[i]) bufs[i] = pattern[(i - 1) % pattern.length];
        renderEditorLists();
    }

    // --- バックアップ機能 ---
    async function exportBackupZip() {
        const zip = new JSZip();
        for (let id in project.stamps) {
            const f = zip.folder(id);
            project.stamps[id].buffers.forEach((b, i) => { if(b) f.file(`${i}.raw`, b); });
        }
        saveBlob(await zip.generateAsync({type:"blob"}), "project_backup.zip");
    }

    async function importProjectZip(input) {
        if(!input.files[0]) return;
        const zip = await JSZip.loadAsync(input.files[0]);
        for (let path in zip.files) {
            const pts = path.split('/'); if(pts.length < 2) continue;
            const id = pts[0], file = pts[1];
            if(project.stamps[id] && file.endsWith(".raw")) {
                const i = parseInt(file);
                project.stamps[id].buffers[i] = await zip.files[path].async("arraybuffer");
            }
        }
        initProject(); alert("復元完了");
    }

    function saveBlob(b, n) {
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = n; a.click();
    }

    initProject();
</script>
</body>
</html>
