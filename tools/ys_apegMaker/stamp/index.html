<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Pro - Ultimate Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        :root { --primary: #2196F3; --accent: #ff5252; --bg: #121212; --card: #1e1e1e; --text: #eee; --checker: #333; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; line-height: 1.4; }
        .transparent-bg { background-color: #222; background-image: linear-gradient(45deg, var(--checker) 25%, transparent 25%), linear-gradient(-45deg, var(--checker) 25%, transparent 25%), linear-gradient(45deg, transparent 75%, var(--checker) 75%), linear-gradient(-45deg, transparent 75%, var(--checker) 75%); background-size: 8px 8px; }
        .screen { display: none; padding: 15px; box-sizing: border-box; min-height: 100vh; }
        .active { display: block; }
        #start-screen { display: flex; align-items: center; justify-content: center; }
        .start-card { background: var(--card); padding: 30px; border-radius: 16px; border: 1px solid #333; width: 100%; max-width: 380px; text-align: center; }
        .input-ui { width: 100%; padding: 10px; margin-top: 10px; background: #000; border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; }
        .project-header { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        .stamp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 10px; }
        .stamp-card { background: var(--card); border-radius: 8px; padding: 6px; border: 1px solid #333; text-align: center; cursor: pointer; }
        .stamp-card .thumb { height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 4px; border: 1px solid #444; margin-bottom: 4px; overflow: hidden; }
        .editor-top-fixed { position: sticky; top: 0; background: var(--bg); z-index: 100; padding-bottom: 10px; border-bottom: 2px solid #333; }
        .preview-wrapper { display: flex; flex-direction: column; align-items: center; padding: 10px 0; }
        #preview-area { border: 2px solid #555; border-radius: 4px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #main-canvas { display: block; image-rendering: pixelated; }
        .btn-group { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; margin-top: 8px; }
        button { padding: 8px 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 11px; color: white; }
        .btn-blue { background: var(--primary); }
        .btn-green { background: #00B900; }
        .btn-orange { background: #FF9800; }
        .btn-red { background: var(--accent); }
        .btn-gray { background: #444; }
        .frame-item { background: var(--card); padding: 6px; border-radius: 8px; display: flex; align-items: center; gap: 8px; margin-bottom: 6px; border: 1px solid #333; }
        .list-thumb { width: 56px; height: 56px; border-radius: 4px; border: 1px solid #666; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .list-thumb img { max-width: 100%; max-height: 100%; }
    </style>
</head>
<body>

<div id="start-screen" class="screen active">
    <div class="start-card">
        <h2 style="margin:0; color:var(--primary);">Studio Pro</h2>
        <input type="text" id="new-project-name" class="input-ui" placeholder="プロジェクト名">
        <select id="profile-select" class="input-ui">
            <option value="stamp">スタンプ (320x270)</option>
            <option value="emoji">絵文字 (180x180)</option>
        </select>
        <button class="btn-blue" style="width:100%; margin-top:15px; padding:12px;" onclick="createNewProject()">作成</button>
        <div style="margin:15px 0; color:#555;">────────</div>
        <button class="btn-gray" style="width:100%;" onclick="document.getElementById('load-zip').click()">復元 (.zip)</button>
        <input type="file" id="load-zip" style="display:none" onchange="importProjectZip(this)">
    </div>
</div>

<div id="project-screen" class="screen">
    <div class="project-header">
        <div style="display:flex; justify-content:space-between;">
            <span id="display-project-name" style="font-weight:bold;">Project</span>
            <button class="btn-gray" onclick="location.reload()">終了</button>
        </div>
        <div class="btn-group">
            <button class="btn-orange" onclick="exportBackupZip()">保存 (Backup)</button>
            <button class="btn-green" style="flex-grow:1" onclick="buildReleaseZip()">一括生成 (ZIP)</button>
        </div>
    </div>
    <div id="special-grid" class="stamp-grid" style="margin-bottom:15px;"></div>
    <div id="stamp-grid" class="stamp-grid"></div>
</div>

<div id="editor-screen" class="screen">
    <div class="editor-top-fixed">
        <button class="btn-gray" onclick="showDashboard()">戻る</button>
        <div class="preview-wrapper">
            <div id="preview-area" class="transparent-bg" onclick="togglePreview()">
                <canvas id="main-canvas"></canvas>
            </div>
            <div id="frame-info-bar" style="margin-top:8px; font-weight:bold; color:var(--primary);">FRAME: 1</div>
        </div>
        <div class="btn-group">
            <button id="delay-100" class="btn-gray" onclick="setDelay(100)">0.1s</button>
            <button id="delay-200" class="btn-gray" onclick="setDelay(200)">0.2s</button>
            <button class="btn-orange" onclick="exportSingleAPNG()">個別保存</button>
        </div>
        <div class="btn-group">
            <button class="btn-blue" onclick="document.getElementById('bulk-upload').click()">一括画像</button>
            <button class="btn-orange" onclick="document.getElementById('apng-import').click()">APNG読込</button>
            <button class="btn-green" onclick="smartFill()">充填</button>
        </div>
        <input type="file" id="bulk-upload" multiple accept="image/*" style="display:none" onchange="handleBulkUpload(this)">
        <input type="file" id="apng-import" accept="image/png" style="display:none" onchange="handleApngImport(this)">
    </div>
    <div id="frames-list" style="margin-top:10px;"></div>
</div>

<script>
    let project = { name: "", profile: "stamp", stamps: {} };
    let currentId = "01", isPlaying = false, previewTimer = null, currentIdx = 0;
    const mainCanvas = document.getElementById('main-canvas');
    const mainCtx = mainCanvas.getContext('2d');

    function getRes(id) {
        if (id === 'main') return { w: 240, h: 240 };
        if (id === 'tab') return { w: 96, h: 74 };
        return (project.profile === 'emoji') ? { w: 180, h: 180 } : { w: 320, h: 270 };
    }

    function createNewProject() {
        project.name = document.getElementById('new-project-name').value || "project";
        project.profile = document.getElementById('profile-select').value;
        const count = (project.profile === 'emoji') ? 40 : 24;
        const ids = (project.profile === 'emoji') ? ['tab'] : ['main', 'tab'];
        for(let i=1; i<=count; i++) ids.push(String(i).padStart(2,'0'));
        ids.forEach(id => { project.stamps[id] = { delay: 100, buffers: new Array(id==='tab'?1:20).fill(null) }; });
        startApp();
    }

    function startApp() {
        document.getElementById('start-screen').classList.remove('active');
        document.getElementById('project-screen').classList.add('active');
        document.getElementById('display-project-name').innerText = project.name;
        initDashboard();
    }

    function initDashboard() {
        const sg = document.getElementById('special-grid'); sg.innerHTML = '';
        const g = document.getElementById('stamp-grid'); g.innerHTML = '';
        Object.keys(project.stamps).forEach(id => {
            const container = (id === 'main' || id === 'tab') ? sg : g;
            renderCard(container, id);
        });
    }

    function renderCard(container, id) {
        const card = document.createElement('div'); card.className = 'stamp-card'; card.onclick = () => openEditor(id);
        const buf = project.stamps[id].buffers[0];
        const res = getRes(id);
        const thumb = buf ? arrayBufferToDataURL(buf, res.w, res.h) : '';
        card.innerHTML = `<div class="thumb transparent-bg">${thumb ? `<img src="${thumb}">`:''}</div><div style="font-size:10px;">${id}</div>`;
        container.appendChild(card);
    }

    function openEditor(id) {
        currentId = id; const res = getRes(id);
        mainCanvas.width = res.w; mainCanvas.height = res.h;
        mainCanvas.style.width = (id === 'tab') ? "192px" : (res.w * 0.8) + "px";
        document.getElementById('project-screen').classList.remove('active');
        document.getElementById('editor-screen').classList.add('active');
        renderEditorLists(); updateStaticPreview(0);
    }

    function renderEditorLists() {
        const list = document.getElementById('frames-list'); list.innerHTML = '';
        project.stamps[currentId].buffers.forEach((buf, i) => {
            const res = getRes(currentId);
            const thumb = buf ? arrayBufferToDataURL(buf, res.w, res.h) : '';
            const div = document.createElement('div'); div.className = 'frame-item';
            div.innerHTML = `<div style="width:20px;">${i+1}</div>
                <div class="list-thumb transparent-bg" onclick="document.getElementById('f-in-${i}').click()">${thumb ? `<img src="${thumb}">`:''}</div>
                <input type="file" id="f-in-${i}" accept="image/*" onchange="loadSingle(${i}, this)" style="display:none">
                <button class="btn-gray" onclick="moveFrame(${i},-1)">▲</button><button class="btn-gray" onclick="moveFrame(${i},1)">▼</button>
                <button class="btn-red" style="margin-left:auto" onclick="deleteFrame(${i})">×</button>`;
            list.appendChild(div);
        });
    }

    function updateStaticPreview(idx) {
        currentIdx = idx; const s = project.stamps[currentId];
        const target = s.buffers[idx] ? idx : s.buffers.findIndex(b => b !== null);
        mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
        if (target !== -1 && s.buffers[target]) {
            mainCtx.putImageData(new ImageData(new Uint8ClampedArray(s.buffers[target]), mainCanvas.width, mainCanvas.height), 0, 0);
            document.getElementById('frame-info-bar').innerText = `FRAME: ${target + 1}`;
        }
    }

    async function handleApngImport(input) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const img = UPNG.decode(e.target.result);
            const frames = UPNG.toRGBA8(img);
            const res = getRes(currentId);
            for (let i = 0; i < frames.length && i < 20; i++) {
                project.stamps[currentId].buffers[i] = await resizeBuffer(new Uint8ClampedArray(frames[i]), img.width, img.height, res.w, res.h);
            }
            renderEditorLists(); updateStaticPreview(0);
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    async function exportSingleAPNG() {
        const bufs = project.stamps[currentId].buffers.filter(b => b !== null);
        if (bufs.length === 0) return;
        const res = getRes(currentId);
        const data = (currentId === 'tab') ? bufs[0] : UPNG.encode(bufs, res.w, res.h, 256, new Array(bufs.length).fill(project.stamps[currentId].delay));
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data], {type:'image/png'})); a.download = `${currentId}.png`; a.click();
    }

    // --- Helpers ---
    function togglePreview() { isPlaying = !isPlaying; if(isPlaying) { const active = project.stamps[currentId].buffers.map((b,i)=>b?i:null).filter(v=>v!==null); let c=0; previewTimer = setInterval(()=> { updateStaticPreview(active[c%active.length]); c++; }, project.stamps[currentId].delay); } else { clearInterval(previewTimer); } }
    async function loadSingle(i, input) { if(input.files[0]) { project.stamps[currentId].buffers[i] = await processImage(input.files[0], currentId); renderEditorLists(); updateStaticPreview(i); } }
    async function handleBulkUpload(input) { const files = Array.from(input.files).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})); for(let i=0; i<20 && i<files.length; i++) project.stamps[currentId].buffers[i] = await processImage(files[i], currentId); renderEditorLists(); updateStaticPreview(0); }
    function processImage(file, id) { return new Promise(resolve => { const res = getRes(id); const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { const cvs = document.createElement('canvas'); cvs.width = res.w; cvs.height = res.h; const ctx = cvs.getContext('2d'); const s = Math.min(res.w/img.width, res.h/img.height); ctx.drawImage(img, (res.w-img.width*s)/2, (res.h-img.height*s)/2, img.width*s, img.height*s); resolve(ctx.getImageData(0,0,res.w,res.h).data.buffer); }; img.src = e.target.result; }; reader.readAsDataURL(file); }); }
    function resizeBuffer(rgba, sw, sh, dw, dh) { return new Promise(resolve => { const c1 = document.createElement('canvas'); c1.width = sw; c1.height = sh; c1.getContext('2d').putImageData(new ImageData(rgba, sw, sh), 0, 0); const c2 = document.createElement('canvas'); c2.width = dw; c2.height = dh; const ctx = c2.getContext('2d'); const s = Math.min(dw/sw, dh/sh); ctx.drawImage(c1, (dw-sw*s)/2, (dh-sh*s)/2, sw*s, sh*s); resolve(ctx.getImageData(0,0,dw,dh).data.buffer); }); }
    function arrayBufferToDataURL(buf, w, h) { const cvs = document.createElement('canvas'); cvs.width = w; cvs.height = h; cvs.getContext('2d').putImageData(new ImageData(new Uint8ClampedArray(buf), w, h), 0,0); return cvs.toDataURL(); }
    function setDelay(ms) { project.stamps[currentId].delay = ms; }
    function moveFrame(i,d) { const b = project.stamps[currentId].buffers, t = i+d; if(t>=0 && t<b.length) { [b[i],b[t]] = [b[t],b[i]]; renderEditorLists(); updateStaticPreview(t); } }
    function deleteFrame(i) { project.stamps[currentId].buffers[i] = null; renderEditorLists(); updateStaticPreview(null); }
    function smartFill() { const b = project.stamps[currentId].buffers, p = b.filter(x=>x!==null); for(let i=0; i<b.length; i++) if(!b[i]) b[i] = p[i%p.length]; renderEditorLists(); }
    function showDashboard() { clearInterval(previewTimer); isPlaying=false; document.getElementById('editor-screen').classList.remove('active'); document.getElementById('project-screen').classList.add('active'); initDashboard(); }
    async function exportBackupZip() { const zip = new JSZip(); zip.file("project.json", JSON.stringify(project, (k,v) => (v instanceof ArrayBuffer) ? Array.from(new Uint8Array(v)) : v)); const b = await zip.generateAsync({type:"blob"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `${project.name}.zip`; a.click(); }
    async function importProjectZip(input) { const zip = await JSZip.loadAsync(input.files[0]); const data = JSON.parse(await zip.file("project.json").async("string")); for(let id in data.stamps) data.stamps[id].buffers = data.stamps[id].buffers.map(b => b ? new Uint8Array(b).buffer : null); project = data; startApp(); }
    async function buildReleaseZip() { const zip = new JSZip(); for(let id in project.stamps) { const bufs = project.stamps[id].buffers.filter(b=>b!==null); if(bufs.length===0) continue; const res = getRes(id); const out = (id==='tab')?bufs[0]:UPNG.encode(bufs, res.w, res.h, 256, new Array(bufs.length).fill(project.stamps[id].delay)); zip.file(`${id}.png`, out); } const b = await zip.generateAsync({type:"blob"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `RELEASE.zip`; a.click(); }
</script>
</body>
</html>
