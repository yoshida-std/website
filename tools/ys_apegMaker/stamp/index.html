<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Pro - Debug Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        :root { --primary: #2196F3; --accent: #ff5252; --bg: #121212; --card: #1e1e1e; --text: #eee; --checker: #333; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        .transparent-bg { background-color: #222; background-image: linear-gradient(45deg, var(--checker) 25%, transparent 25%), linear-gradient(-45deg, var(--checker) 25%, transparent 25%), linear-gradient(45deg, transparent 75%, var(--checker) 75%), linear-gradient(-45deg, transparent 75%, var(--checker) 75%); background-size: 8px 8px; }
        
        /* デバッグ背景色 */
        .debug-none { }
        .debug-red { background-color: #b3261e !important; background-image: none !important; }
        .debug-yellow { background-color: #f9ab00 !important; background-image: none !important; color: #000 !important; }

        .screen { display: none; padding: 15px; box-sizing: border-box; min-height: 100vh; }
        .active { display: block; }

        /* エディタ：上部固定プレビュー */
        .editor-top-fixed { position: sticky; top: 0; background: var(--bg); z-index: 100; padding-bottom: 10px; border-bottom: 2px solid #333; }
        .preview-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 0; }
        
        #preview-area { border: 2px solid #555; border-radius: 4px; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #main-canvas { display: block; image-rendering: pixelated; } /* 拡大してもボヤけない設定 */
        
        #frame-info-bar { margin-top: 8px; font-weight: bold; color: var(--primary); font-size: 18px; text-shadow: 0 0 5px rgba(33, 150, 243, 0.5); }

        /* ボタン類 */
        .btn-group { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; margin-top: 8px; }
        button { padding: 8px 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 11px; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: #00B900; color: white; }
        .btn-orange { background: #FF9800; color: white; }
        .btn-red { background: var(--accent); color: white; }
        .btn-gray { background: #444; color: white; }
        .btn-active { box-shadow: 0 0 0 2px white inset; }

        /* フレームリスト */
        .frame-item { background: var(--card); padding: 6px; border-radius: 8px; display: flex; align-items: center; gap: 8px; margin-bottom: 6px; border: 1px solid #333; }
        .list-thumb { width: 56px; height: 56px; border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border: 1px solid #666; cursor: pointer; overflow: hidden; }
        .list-thumb img { max-width: 100%; max-height: 100%; }
        
        .debug-controls { display: flex; flex-direction: column; gap: 2px; }
        .btn-debug { padding: 4px; font-size: 9px; min-width: 32px; }

        .stamp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 10px; }
        .stamp-card { background: var(--card); border-radius: 8px; padding: 6px; border: 1px solid #333; text-align: center; cursor: pointer; }
        .stamp-card .thumb { height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 4px; border: 1px solid #444; margin-bottom: 4px; }
    </style>
</head>
<body>

<div id="project-screen" class="screen active">
    <h2 style="margin:0 0 10px 0;">Studio Pro</h2>
    <div style="margin-bottom:15px; background:var(--card); padding:10px; border-radius:10px;">
        名前: <input type="text" id="project-name" value="my_apng" style="background:#000; color:#fff; border:1px solid #444; padding:5px; width:100px;">
        <div class="btn-group" style="margin-top:10px;">
            <button class="btn-gray" onclick="exportBackupZip()">保存</button>
            <button class="btn-gray" onclick="document.getElementById('load-zip').click()">復元</button>
            <input type="file" id="load-zip" style="display:none" onchange="importProjectZip(this)">
            <button class="btn-green" onclick="buildReleaseZip()">一括生成</button>
        </div>
    </div>
    <div id="special-grid" class="stamp-grid" style="margin-bottom:20px; border-bottom:1px solid #444; padding-bottom:15px;"></div>
    <div id="stamp-grid" class="stamp-grid"></div>
</div>

<div id="editor-screen" class="screen">
    <div class="editor-top-fixed">
        <button class="btn-gray" onclick="showDashboard()" style="position:absolute; left:10px; top:10px;">戻る</button>
        
        <div class="preview-wrapper">
            <div id="preview-area" class="transparent-bg" onclick="togglePreview()">
                <canvas id="main-canvas"></canvas>
            </div>
            <div id="frame-info-bar">FRAME: 1</div>
        </div>

        <div class="btn-group">
            <button id="delay-100" class="btn-gray" onclick="setDelay(100)">0.1s (計2s)</button>
            <button id="delay-200" class="btn-gray" onclick="setDelay(200)">0.2s (計4s)</button>
            <button class="btn-orange" onclick="exportSingleAPNG()">個別保存</button>
        </div>
        <div class="btn-group">
            <button class="btn-blue" onclick="document.getElementById('bulk-upload').click()">一括読込</button>
            <button class="btn-green" id="fill-btn" onclick="smartFill()">パターン充填</button>
            <input type="file" id="bulk-upload" multiple accept="image/*" style="display:none" onchange="handleBulkUpload(this)">
        </div>
    </div>

    <div id="frames-list" style="margin-top:15px;"></div>
</div>

<script>
    const CONFIG = {
        main: { w: 240, h: 240, maxF: 20, label: "Main" },
        tab: { w: 96, h: 74, maxF: 1, label: "Tab" },
        stamp: { w: 320, h: 270, maxF: 20, label: "Stamp" }
    };

    let project = { stamps: {} };
    let currentId = "01", currentType = "stamp", isPlaying = false, previewTimer = null, currentIdx = 0;

    const mainCanvas = document.getElementById('main-canvas');
    const mainCtx = mainCanvas.getContext('2d');

    function initProject() {
        const sg = document.getElementById('special-grid');
        sg.innerHTML = '';
        ['main', 'tab'].forEach(id => {
            if (!project.stamps[id]) project.stamps[id] = { delay: 100, buffers: new Array(CONFIG[id].maxF).fill(null), debugBgs: new Array(CONFIG[id].maxF).fill('debug-none') };
            renderCard(sg, id, CONFIG[id].label);
        });
        const g = document.getElementById('stamp-grid');
        g.innerHTML = '';
        for (let i = 1; i <= 24; i++) {
            const id = String(i).padStart(2, '0');
            if (!project.stamps[id]) project.stamps[id] = { delay: 100, buffers: new Array(20).fill(null), debugBgs: new Array(20).fill('debug-none') };
            renderCard(g, id, `#${id}`);
        }
    }

    function renderCard(container, id, label) {
        const card = document.createElement('div');
        card.className = 'stamp-card';
        card.onclick = () => openEditor(id);
        const buf = project.stamps[id].buffers[0];
        const thumbSrc = buf ? arrayBufferToDataURL(buf, (id==='main'||id==='tab')?id:'stamp') : '';
        card.innerHTML = `<div class="thumb transparent-bg">${thumbSrc ? `<img src="${thumbSrc}" style="max-width:100%;max-height:100%">`:''}</div><div style="font-size:10px;">${label}</div>`;
        container.appendChild(card);
    }

    function openEditor(id) {
        currentId = id; currentType = (id === 'main' || id === 'tab') ? id : 'stamp';
        const sData = project.stamps[id];
        
        // 解像度セット
        mainCanvas.width = CONFIG[currentType].w;
        mainCanvas.height = CONFIG[currentType].h;
        // 表示サイズ調整（スマホで見やすいよう少し縮小）
        const displayScale = 0.8;
        mainCanvas.style.width = (CONFIG[currentType].w * displayScale) + 'px';
        mainCanvas.style.height = (CONFIG[currentType].h * displayScale) + 'px';

        document.getElementById('project-screen').classList.remove('active');
        document.getElementById('editor-screen').classList.add('active');
        
        updateDelayUI();
        renderEditorLists();
        updateStaticPreview(0);
    }

    function renderEditorLists() {
        const list = document.getElementById('frames-list');
        list.innerHTML = '';
        const sData = project.stamps[currentId];
        sData.buffers.forEach((buf, i) => {
            const thumbSrc = buf ? arrayBufferToDataURL(buf, currentType) : '';
            const debugClass = sData.debugBgs[i] || 'debug-none';
            const div = document.createElement('div');
            div.className = 'frame-item';
            div.innerHTML = `
                <div style="font-size:14px; width:20px; font-weight:bold;">${i+1}</div>
                <div class="list-thumb transparent-bg ${debugClass}" onclick="document.getElementById('file-${i}').click()">
                    ${thumbSrc ? `<img src="${thumbSrc}">` : '<span style="font-size:8px;">TAP</span>'}
                    <input type="file" id="file-${i}" accept="image/*" onchange="loadSingle(${i}, this)" style="display:none">
                </div>
                <div class="debug-controls">
                    <button class="btn-debug btn-gray ${debugClass==='debug-none'?'btn-active':''}" onclick="setDebugBg(${i}, 'debug-none')">標</button>
                    <button class="btn-debug btn-red ${debugClass==='debug-red'?'btn-active':''}" onclick="setDebugBg(${i}, 'debug-red')">赤</button>
                    <button class="btn-debug btn-orange ${debugClass==='debug-yellow'?'btn-active':''}" onclick="setDebugBg(${i}, 'debug-yellow')">黄</button>
                </div>
                <div style="margin-left:auto; display:flex; flex-direction:column; gap:2px;">
                    <button class="btn-gray" style="padding:4px 8px" onclick="moveFrame(${i}, -1)">▲</button>
                    <button class="btn-gray" style="padding:4px 8px" onclick="moveFrame(${i}, 1)">▼</button>
                </div>
                <button class="btn-red" style="padding:15px 10px" onclick="deleteFrame(${i})">×</button>
            `;
            list.appendChild(div);
        });
    }

    function setDebugBg(i, className) {
        project.stamps[currentId].debugBgs[i] = className;
        renderEditorLists();
        updateStaticPreview(currentIdx);
    }

    function updateStaticPreview(idx) {
        currentIdx = idx;
        const sData = project.stamps[currentId];
        const bufs = sData.buffers;
        const target = (idx !== null && bufs[idx]) ? idx : bufs.findIndex(b => b !== null);
        
        // プレビューエリアの背景をデバッグ色に更新
        const bgClass = (target !== -1) ? (sData.debugBgs[target] || 'debug-none') : 'debug-none';
        document.getElementById('preview-area').className = 'transparent-bg ' + bgClass;

        mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
        if (target !== -1 && bufs[target]) {
            mainCtx.putImageData(new ImageData(new Uint8ClampedArray(bufs[target]), mainCanvas.width, mainCanvas.height), 0, 0);
            document.getElementById('frame-info-bar').innerText = `FRAME: ${target + 1}`;
        }
    }

    function togglePreview() {
        if (CONFIG[currentType].maxF === 1) return;
        isPlaying = !isPlaying;
        if (isPlaying) {
            const active = project.stamps[currentId].buffers.map((b,i)=> b?i:null).filter(v=>v!==null);
            if(active.length === 0) { isPlaying = false; return; }
            let c = 0;
            previewTimer = setInterval(() => {
                updateStaticPreview(active[c % active.length]);
                c++;
            }, project.stamps[currentId].delay);
        } else { clearInterval(previewTimer); }
    }

    // --- その他基本機能 (以前の安定版を継承) ---
    function setDelay(ms) { project.stamps[currentId].delay = ms; updateDelayUI(); if(isPlaying){togglePreview();togglePreview();} }
    function updateDelayUI() { const d = project.stamps[currentId].delay; document.getElementById('delay-100').className = d===100?'btn-blue':'btn-gray'; document.getElementById('delay-200').className = d===200?'btn-blue':'btn-gray'; }
    async function loadSingle(i, input) { if (!input.files[0]) return; project.stamps[currentId].buffers[i] = await processImage(input.files[0], currentType); renderEditorLists(); updateStaticPreview(i); }
    async function handleBulkUpload(input) { 
        const files = Array.from(input.files).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}));
        for (let i=0; i<project.stamps[currentId].buffers.length && i<files.length; i++) {
            project.stamps[currentId].buffers[i] = await processImage(files[i], currentType);
        }
        renderEditorLists(); updateStaticPreview(0);
    }
    function moveFrame(i, d) { 
        const b = project.stamps[currentId].buffers; const db = project.stamps[currentId].debugBgs;
        const t = i+d; if(t<0 || t>=b.length) return;
        [b[i],b[t]] = [b[t],b[i]]; [db[i],db[t]] = [db[t],db[i]];
        renderEditorLists(); updateStaticPreview(t);
    }
    function deleteFrame(i) { project.stamps[currentId].buffers[i] = null; renderEditorLists(); updateStaticPreview(null); }
    function smartFill() { 
        const b = project.stamps[currentId].buffers; const p = b.filter(x=>x!==null);
        if(p.length<1) return;
        for(let i=0; i<b.length; i++) if(!b[i]) b[i] = p[i % p.length];
        renderEditorLists();
    }
    function processImage(file, type) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas'); cvs.width = CONFIG[type].w; cvs.height = CONFIG[type].h;
                    const c = cvs.getContext('2d'); const s = Math.min(cvs.width/img.width, cvs.height/img.height);
                    c.drawImage(img, (cvs.width-img.width*s)/2, (cvs.height-img.height*s)/2, img.width*s, img.height*s);
                    resolve(c.getImageData(0,0,cvs.width,cvs.height).data.buffer);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }
    function arrayBufferToDataURL(buf, type) {
        const cvs = document.createElement('canvas'); cvs.width = CONFIG[type].w; cvs.height = CONFIG[type].h;
        cvs.getContext('2d').putImageData(new ImageData(new Uint8ClampedArray(buf), cvs.width, cvs.height), 0,0);
        return cvs.toDataURL();
    }
    function encodeApng(bufs, w, h, d) {
        const apng = UPNG.encode(bufs, w, h, 256, new Array(bufs.length).fill(d));
        const v = new DataView(apng); let o = 8;
        while(o < apng.byteLength) {
            const l = v.getUint32(o), t = v.getUint32(o+4);
            if(t===0x6163544C) { v.setUint32(o+12, 1); break; }
            o += 12 + l;
        }
        return apng;
    }
    async function exportSingleAPNG() {
        const active = project.stamps[currentId].buffers.filter(b=>b!==null);
        if(active.length===0) return;
        const apng = encodeApng(active, CONFIG[currentType].w, CONFIG[currentType].h, project.stamps[currentId].delay);
        saveBlob(new Blob([apng], {type:'image/png'}), `${currentId}.png`);
    }
    async function buildReleaseZip() {
        const zip = new JSZip();
        for(let id in project.stamps) {
            const active = project.stamps[id].buffers.filter(b=>b!==null); if(active.length===0) continue;
            const t = (id==='main'||id==='tab')?id:'stamp';
            zip.file(`${id}.png`, encodeApng(active, CONFIG[t].w, CONFIG[t].h, project.stamps[id].delay));
        }
        saveBlob(await zip.generateAsync({type:"blob"}), "release.zip");
    }
    function showDashboard() { clearInterval(previewTimer); isPlaying=false; document.getElementById('editor-screen').classList.remove('active'); document.getElementById('project-screen').classList.add('active'); initProject(); }
    function saveBlob(b, n) { const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = n; a.click(); }
    
    // バックアップ機能の拡張（デバッグ背景色も保存）
    async function exportBackupZip() {
        const zip = new JSZip();
        zip.file("project.json", JSON.stringify({stamps: project.stamps}, (key, value) => {
            if (value instanceof ArrayBuffer) return Array.from(new Uint8Array(value));
            return value;
        }));
        saveBlob(await zip.generateAsync({type:"blob"}), "backup.zip");
    }
    async function importProjectZip(input) {
        const zip = await JSZip.loadAsync(input.files[0]);
        const data = JSON.parse(await zip.file("project.json").async("string"));
        for(let id in data.stamps) {
            data.stamps[id].buffers = data.stamps[id].buffers.map(b => b ? new Uint8Array(b).buffer : null);
        }
        project.stamps = data.stamps; initProject();
    }

    initProject();
</script>
</body>
</html>
