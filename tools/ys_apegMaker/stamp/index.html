<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Pro - Multi Profile Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        :root { --primary: #2196F3; --accent: #ff5252; --bg: #121212; --card: #1e1e1e; --text: #eee; --checker: #333; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }
        button { padding: 10px 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        button:active { opacity: 0.7; transform: scale(0.98); }
        .btn-blue { background: var(--primary); }
        .btn-green { background: #00B900; }
        .btn-gray { background: #444; }
        .btn-orange { background: #FF9800; }
        
        .screen { display: none; padding: 20px; box-sizing: border-box; min-height: 100vh; }
        .active { display: flex; flex-direction: column; }

        /* スタート画面 */
        #start-screen { align-items: center; justify-content: center; text-align: center; }
        .start-card { background: var(--card); padding: 30px; border-radius: 16px; border: 1px solid #333; width: 100%; max-width: 400px; }
        .input-field { width: 100%; padding: 10px; margin: 10px 0; background: #000; border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; }

        /* ダッシュボード */
        .project-header { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        .stamp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .stamp-card { background: var(--card); border-radius: 8px; padding: 6px; border: 1px solid #333; text-align: center; cursor: pointer; }
        .stamp-card .thumb { height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 4px; border: 1px solid #444; margin-bottom: 4px; overflow: hidden; }
        .transparent-bg { background-image: linear-gradient(45deg, var(--checker) 25%, transparent 25%), linear-gradient(-45deg, var(--checker) 25%, transparent 25%), linear-gradient(45deg, transparent 75%, var(--checker) 75%), linear-gradient(-45deg, transparent 75%, var(--checker) 75%); background-size: 8px 8px; background-color: #222; }

        /* エディタ */
        .editor-top-fixed { position: sticky; top: 0; background: var(--bg); z-index: 100; padding-bottom: 10px; border-bottom: 2px solid #333; }
        .preview-wrapper { display: flex; flex-direction: column; align-items: center; padding: 10px 0; }
        #preview-area { border: 2px solid #555; border-radius: 4px; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #main-canvas { display: block; image-rendering: pixelated; }
        .frame-item { background: var(--card); padding: 8px; border-radius: 10px; display: flex; align-items: center; gap: 10px; margin-bottom: 8px; border: 1px solid #333; }
        .list-thumb { width: 50px; height: 50px; border-radius: 4px; border: 1px solid #666; overflow: hidden; cursor: pointer; }
        .list-thumb img { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>

<div id="start-screen" class="screen active">
    <div class="start-card">
        <h1 style="margin-top:0; color:var(--primary);">Studio Pro</h1>
        <p style="color:#888; font-size:14px;">プロジェクトを開始してください</p>
        <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
        
        <div style="text-align:left; font-size:12px; margin-bottom:5px; color:#aaa;">新規プロジェクト名</div>
        <input type="text" id="new-project-name" class="input-field" placeholder="my_project_01">
        
        <div style="text-align:left; font-size:12px; margin-bottom:5px; color:#aaa;">プロファイル</div>
        <select id="profile-select" class="input-field">
            <option value="stamp">アニメーションスタンプ (24枚)</option>
            <option value="emoji">アニメーション絵文字 (40枚)</option>
        </select>
        
        <button class="btn-blue" style="width:100%; margin-top:10px;" onclick="createNewProject()">新規作成</button>
        
        <div style="margin:20px 0; color:#555;">OR</div>
        
        <button class="btn-gray" style="width:100%;" onclick="document.getElementById('load-zip').click()">既存プロジェクトをロード</button>
        <input type="file" id="load-zip" style="display:none" onchange="importProjectZip(this)">
    </div>
</div>

<div id="project-screen" class="screen">
    <div class="project-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="display-project-name" style="margin:0;">Project</h2>
            <button class="btn-gray" onclick="location.reload()">閉じる</button>
        </div>
        <div class="btn-group" style="margin-top:10px; display:flex; gap:5px;">
            <button class="btn-orange" style="flex:1" onclick="exportBackupZip()">保存(Backup)</button>
            <button class="btn-green" style="flex:2" onclick="buildReleaseZip()">一括APNG生成</button>
        </div>
    </div>
    
    <div style="font-size:12px; color:#888; margin-bottom:5px;">管理用画像 (Tab)</div>
    <div id="special-grid" class="stamp-grid" style="margin-bottom:20px; border-bottom:1px solid #444; padding-bottom:15px;"></div>
    
    <div id="main-label" style="font-size:12px; color:#888; margin-bottom:5px;">コンテンツ一覧</div>
    <div id="stamp-grid" class="stamp-grid"></div>
</div>

<div id="editor-screen" class="screen">
    <div class="editor-top-fixed">
        <button class="btn-gray" onclick="showDashboard()" style="position:absolute; left:10px; top:10px;">戻る</button>
        <div class="preview-wrapper">
            <div id="preview-area" class="transparent-bg" onclick="togglePreview()">
                <canvas id="main-canvas"></canvas>
            </div>
            <div id="frame-info-bar" style="margin-top:5px; font-weight:bold; color:var(--primary);">FRAME: 1</div>
        </div>
        
        <div id="anim-controls">
            <div style="display:flex; gap:5px; justify-content:center; margin-bottom:8px;">
                <button id="delay-100" class="btn-gray" onclick="setDelay(100)">0.1s</button>
                <button id="delay-200" class="btn-gray" onclick="setDelay(200)">0.2s</button>
                <button class="btn-orange" onclick="exportSingleAPNG()">個別保存</button>
            </div>
            <div style="display:flex; gap:5px; justify-content:center;">
                <button class="btn-blue" onclick="document.getElementById('bulk-upload').click()">一括読込</button>
                <button class="btn-green" onclick="smartFill()">パターン充填</button>
            </div>
        </div>

        <div id="tab-controls" style="display:none; text-align:center;">
            <button class="btn-blue" onclick="document.getElementById('file-0').click()">画像を読込</button>
            <button class="btn-orange" onclick="exportSingleAPNG()">個別保存</button>
            <p style="font-size:11px; color:#888;">Tab画像は静止画1枚のみです</p>
        </div>

        <input type="file" id="bulk-upload" multiple accept="image/*" style="display:none" onchange="handleBulkUpload(this)">
    </div>
    <div id="frames-list" style="margin-top:10px;"></div>
</div>

<script>
    const PROFILES = {
        stamp: { label: "スタンプ", slots: 24, stampW: 320, stampH: 270, hasMain: true },
        emoji: { label: "絵文字", slots: 40, stampW: 180, stampH: 180, hasMain: false }
    };

    let project = { name: "", profile: "stamp", stamps: {} };
    let currentId = "", currentType = "", isPlaying = false, previewTimer = null, currentIdx = 0;
    const mainCanvas = document.getElementById('main-canvas');
    const mainCtx = mainCanvas.getContext('2d');

    function createNewProject() {
        const name = document.getElementById('new-project-name').value.trim() || "my_project";
        const profKey = document.getElementById('profile-select').value;
        project = { name: name, profile: profKey, stamps: {} };
        
        // 特殊枠の初期化 (Main, Tab)
        const specs = ["tab"];
        if (PROFILES[profKey].hasMain) specs.push("main");
        
        specs.forEach(id => {
            project.stamps[id] = { delay: 100, buffers: new Array(id==='tab'?1:20).fill(null), debugBgs: new Array(20).fill('debug-none') };
        });

        // スタンプ枠の初期化
        for (let i = 1; i <= PROFILES[profKey].slots; i++) {
            const id = String(i).padStart(2, '0');
            project.stamps[id] = { delay: 100, buffers: new Array(20).fill(null), debugBgs: new Array(20).fill('debug-none') };
        }

        startApp();
    }

    function startApp() {
        document.getElementById('start-screen').classList.remove('active');
        document.getElementById('project-screen').classList.add('active');
        document.getElementById('display-project-name').innerText = project.name;
        initDashboard();
    }

    function initDashboard() {
        const sg = document.getElementById('special-grid'); sg.innerHTML = '';
        const prof = PROFILES[project.profile];
        
        // Tab / Main
        if (prof.hasMain) renderCard(sg, 'main', 'Main');
        renderCard(sg, 'tab', 'Tab');

        // Grid
        const g = document.getElementById('stamp-grid'); g.innerHTML = '';
        document.getElementById('main-label').innerText = `${prof.label}一覧 (${prof.slots}枚)`;
        for (let i = 1; i <= prof.slots; i++) {
            const id = String(i).padStart(2, '0');
            renderCard(g, id, `#${id}`);
        }
    }

    function renderCard(container, id, label) {
        const card = document.createElement('div');
        card.className = 'stamp-card';
        card.onclick = () => openEditor(id);
        const buf = project.stamps[id].buffers[0];
        const thumbSrc = buf ? arrayBufferToDataURL(buf, getDim(id)) : '';
        card.innerHTML = `<div class="thumb transparent-bg">${thumbSrc ? `<img src="${thumbSrc}" style="max-width:100%;max-height:100%">`:''}</div><div style="font-size:10px;">${label}</div>`;
        container.appendChild(card);
    }

    function getDim(id) {
        if (id === 'main') return { w: 240, h: 240 };
        if (id === 'tab') return { w: 96, h: 74 };
        return { w: PROFILES[project.profile].stampW, h: PROFILES[project.profile].stampH };
    }

    function openEditor(id) {
        currentId = id;
        currentType = (id === 'main' || id === 'tab') ? id : 'content';
        const dim = getDim(id);
        mainCanvas.width = dim.w; mainCanvas.height = dim.h;
        
        const scale = id === 'tab' ? 2 : (dim.w > 300 ? 0.7 : 1.2);
        mainCanvas.style.width = (dim.w * scale) + 'px';
        mainCanvas.style.height = (dim.h * scale) + 'px';

        document.getElementById('anim-controls').style.display = (id === 'tab') ? 'none' : 'block';
        document.getElementById('tab-controls').style.display = (id === 'tab') ? 'block' : 'none';
        
        document.getElementById('project-screen').classList.remove('active');
        document.getElementById('editor-screen').classList.add('active');
        renderEditorLists(); updateStaticPreview(0);
    }

    function showDashboard() {
        clearInterval(previewTimer); isPlaying = false;
        document.getElementById('editor-screen').classList.remove('active');
        document.getElementById('project-screen').classList.add('active');
        initDashboard();
    }

    // --- Core Editor Logic ---
    function renderEditorLists() {
        const list = document.getElementById('frames-list'); list.innerHTML = '';
        if (currentId === 'tab') return;
        project.stamps[currentId].buffers.forEach((buf, i) => {
            const div = document.createElement('div');
            div.className = 'frame-item';
            const thumbSrc = buf ? arrayBufferToDataURL(buf, getDim(currentId)) : '';
            div.innerHTML = `
                <div style="font-weight:bold; color:var(--primary); width:20px;">${i+1}</div>
                <div class="list-thumb transparent-bg" onclick="document.getElementById('file-${i}').click()">
                    ${thumbSrc ? `<img src="${thumbSrc}">` : ''}
                </div>
                <input type="file" id="file-${i}" accept="image/*" onchange="loadSingle(${i}, this)" style="display:none">
                <button class="btn-gray" onclick="moveFrame(${i}, -1)">▲</button>
                <button class="btn-gray" onclick="moveFrame(${i}, 1)">▼</button>
                <button class="btn-red" style="margin-left:auto; background:var(--accent);" onclick="deleteFrame(${i})">×</button>
            `;
            list.appendChild(div);
        });
    }

    async function loadSingle(i, input) {
        if (!input.files[0]) return;
        project.stamps[currentId].buffers[i] = await processImage(input.files[0], getDim(currentId));
        renderEditorLists(); updateStaticPreview(i);
    }

    function updateStaticPreview(idx) {
        currentIdx = idx;
        const s = project.stamps[currentId];
        const buf = s.buffers[idx] || s.buffers.find(b => b !== null);
        mainCtx.clearRect(0,0,mainCanvas.width, mainCanvas.height);
        if (buf) {
            mainCtx.putImageData(new ImageData(new Uint8ClampedArray(buf), mainCanvas.width, mainCanvas.height), 0,0);
            document.getElementById('frame-info-bar').innerText = `FRAME: ${idx + 1}`;
        }
    }

    function togglePreview() {
        if (currentId === 'tab' || isPlaying) { clearInterval(previewTimer); isPlaying = false; return; }
        const activeIdx = project.stamps[currentId].buffers.map((b,i)=>b?i:null).filter(v=>v!==null);
        if (activeIdx.length < 1) return;
        isPlaying = true; let c = 0;
        previewTimer = setInterval(() => {
            updateStaticPreview(activeIdx[c % activeIdx.length]);
            c++;
        }, project.stamps[currentId].delay);
    }

    function processImage(file, dim) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas'); cvs.width = dim.w; cvs.height = dim.h;
                    const ctx = cvs.getContext('2d');
                    const s = Math.min(dim.w/img.width, dim.h/img.height);
                    ctx.drawImage(img, (dim.w-img.width*s)/2, (dim.h-img.height*s)/2, img.width*s, img.height*s);
                    resolve(ctx.getImageData(0,0,dim.w,dim.h).data.buffer);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    function arrayBufferToDataURL(buf, dim) {
        const cvs = document.createElement('canvas'); cvs.width = dim.w; cvs.height = dim.h;
        cvs.getContext('2d').putImageData(new ImageData(new Uint8ClampedArray(buf), dim.w, dim.h), 0,0);
        return cvs.toDataURL();
    }

    // --- Save / Load ---
    function getTS() { return new Date().toISOString().replace(/[:T-]/g,'').slice(0,14); }

    async function exportBackupZip() {
        const zip = new JSZip();
        zip.file("project.json", JSON.stringify(project, (k,v) => v instanceof ArrayBuffer ? Array.from(new Uint8Array(v)) : v));
        const blob = await zip.generateAsync({type:"blob"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `${project.name}_${getTS()}.zip`; a.click();
    }

    async function importProjectZip(input) {
        const zip = await JSZip.loadAsync(input.files[0]);
        const data = JSON.parse(await zip.file("project.json").async("string"));
        // restore buffers
        for (let id in data.stamps) {
            data.stamps[id].buffers = data.stamps[id].buffers.map(b => b ? new Uint8Array(b).buffer : null);
        }
        project = data;
        startApp();
    }

    async function buildReleaseZip() {
        const zip = new JSZip();
        for (let id in project.stamps) {
            const active = project.stamps[id].buffers.filter(b => b !== null);
            if (active.length === 0) continue;
            const dim = getDim(id);
            const out = (id === 'tab') ? active[0] : UPNG.encode(active, dim.w, dim.h, 256, new Array(active.length).fill(project.stamps[id].delay));
            zip.file(`${id}.png`, out);
        }
        const blob = await zip.generateAsync({type:"blob"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `RELEASE_${project.name}_${getTS()}.zip`; a.click();
    }

    // Utils
    function setDelay(ms) { project.stamps[currentId].delay = ms; }
    function deleteFrame(i) { project.stamps[currentId].buffers[i] = null; renderEditorLists(); }
    function moveFrame(i, d) {
        const b = project.stamps[currentId].buffers;
        if (i+d < 0 || i+d >= b.length) return;
        [b[i], b[i+d]] = [b[i+d], b[i]];
        renderEditorLists();
    }
    async function handleBulkUpload(input) {
        const files = Array.from(input.files).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}));
        for (let i=0; i<files.length && i<20; i++) {
            project.stamps[currentId].buffers[i] = await processImage(files[i], getDim(currentId));
        }
        renderEditorLists(); updateStaticPreview(0);
    }
    function smartFill() {
        const b = project.stamps[currentId].buffers;
        const filled = b.filter(x => x !== null);
        if (filled.length === 0) return;
        for (let i=0; i<20; i++) { if (!b[i]) b[i] = filled[i % filled.length]; }
        renderEditorLists();
    }
</script>

<input type="file" id="file-0" accept="image/*" onchange="loadSingle(0, this)" style="display:none">

</body>
</html>
