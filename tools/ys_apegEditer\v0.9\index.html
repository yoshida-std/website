<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>APEG Editor v0.9</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    
    <style>
        :root { --primary: #2196F3; --accent: #ff5252; --bg: #121212; --card: #1e1e1e; --text: #eee; --checker: #333; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; line-height: 1.4; overflow-x: hidden; }
        .transparent-bg { background-color: #222; background-image: linear-gradient(45deg, var(--checker) 25%, transparent 25%), linear-gradient(-45deg, var(--checker) 25%, transparent 25%), linear-gradient(45deg, transparent 75%, var(--checker) 75%), linear-gradient(-45deg, transparent 75%, var(--checker) 75%); background-size: 8px 8px; }
        
        .debug-none { background-image: linear-gradient(45deg, var(--checker) 25%, transparent 25%), linear-gradient(-45deg, var(--checker) 25%, transparent 25%), linear-gradient(45deg, transparent 75%, var(--checker) 75%), linear-gradient(-45deg, transparent 75%, var(--checker) 75%) !important; }
        .debug-red { background: #600 !important; background-image: none !important; }
        .debug-yellow { background: #660 !important; background-image: none !important; }

        #setup-screen, #loading-screen { position: fixed; inset: 0; background: rgba(18, 18, 18, 0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        #loading-screen { display: none; z-index: 10000; flex-direction: column; }
        .setup-card { background: var(--card); padding: 30px; border-radius: 15px; border: 1px solid #333; text-align: center; max-width: 340px; width: 90%; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .screen { display: none; padding: 15px; box-sizing: border-box; min-height: 100vh; }
        .active { display: block; }
        .project-header { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        .stamp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 10px; }
        .stamp-card { background: var(--card); border-radius: 8px; padding: 6px; border: 1px solid #333; text-align: center; cursor: pointer; }
        .stamp-card .thumb { height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 4px; border: 1px solid #444; margin-bottom: 4px; overflow: hidden; }
        .editor-top-fixed { position: sticky; top: 0; background: var(--bg); z-index: 100; padding-bottom: 10px; border-bottom: 2px solid #333; }
        .preview-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 0; }
        #preview-area { border: 2px solid #555; border-radius: 4px; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #main-canvas { display: block; image-rendering: pixelated; position: relative; z-index: 2; }
        .btn-group { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; margin-top: 8px; }
        button { padding: 10px 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 11px; color: white; transition: 0.2s; }
        .btn-blue { background: var(--primary); } .btn-green { background: #00B900; } .btn-orange { background: #FF9800; } .btn-red { background: var(--accent); } .btn-gray { background: #444; }
        
        .frame-item { background: var(--card); padding: 6px; border-radius: 8px; display: flex; align-items: center; gap: 8px; margin-bottom: 6px; border: 1px solid #333; transition: 0.2s; }
        .frame-item.selected { border-color: var(--primary); background: #252525; box-shadow: 0 0 8px rgba(33, 150, 243, 0.3); }
        .frame-item.disabled { opacity: 0.5; filter: grayscale(1); }
        .list-thumb { width: 56px; height: 56px; border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border: 1px solid #666; overflow: hidden; cursor: pointer; }
        .list-thumb img { max-width: 100%; max-height: 100%; }
        .btn-debug { padding: 4px; font-size: 9px; height: 50px; min-width: 34px; color: #fff; border: 1px solid #555; }
        .btn-active { box-shadow: 0 0 0 2px white inset; }
        .frame-check { width: 20px; height: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="spinner"></div>
    <div id="loading-text" style="color:white; font-size:14px;">処理中...</div>
</div>

<div id="setup-screen">
    <div class="setup-card">
        <h2 style="margin-top:0; color:var(--primary);">APEG Editor v0.9</h2>
        <button class="btn-blue" style="width:100%; padding:15px; margin-bottom:10px;" onclick="applyProfile('stamp')">アニメスタンプ (320x270)</button>
        <button class="btn-orange" style="width:100%; padding:15px; margin-bottom:10px;" onclick="applyProfile('emoji')">アニメ絵文字 (180x180)</button>
        <div style="border-top:1px solid #444; margin:15px 0; padding-top:15px;">
            <button class="btn-gray" style="width:100%;" onclick="document.getElementById('load-proj-setup').click()">プロジェクトの読込</button>
            <input type="file" id="load-proj-setup" style="display:none" onchange="importProjectZip(this)">
        </div>
© 2026 Yoshida Studio
    </div>
</div>

<div id="project-screen" class="screen">
© 2026 Yoshida Studio
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
        <h2 style="margin:0;">APEG Editor v0.9</h2>
        <button class="btn-red" onclick="location.reload()">再起動</button>
    </div>
    <div class="project-header">
        プロジェクト名: <input type="text" id="project-name" value="my_project" style="background:#000; color:#fff; border:1px solid #444; padding:5px; width:120px; border-radius:4px;">
        <div class="btn-group" style="margin-top:15px;">
            <button class="btn-orange" style="flex:1; padding:12px;" onclick="buildProjectZip()">プロジェクトの保存</button>
            <button class="btn-gray" style="flex:1; padding:12px;" onclick="document.getElementById('load-proj-dash').click()">プロジェクトの読込</button>
            <input type="file" id="load-proj-dash" style="display:none" onchange="importProjectZip(this)">
        </div>
    </div>
    <div id="special-grid" class="stamp-grid" style="margin-bottom:20px; border-bottom:1px solid #444; padding-bottom:15px;"></div>
    <div id="stamp-grid" class="stamp-grid"></div>
</div>

<div id="editor-screen" class="screen">
© 2026 Yoshida Studio
    <div class="editor-top-fixed">
        <button class="btn-gray" onclick="showDashboard()" style="position:absolute; left:10px; top:10px;">戻る</button>
        <div class="preview-wrapper">
            <div id="preview-area" class="transparent-bg" onclick="togglePreview()">
                <canvas id="main-canvas"></canvas>
            </div>
            <div class="btn-group">
	            <div id="frame-info-bar" style="margin-top:8px; font-weight:bold; color:var(--primary); font-size:18px;">FRAME: 1</div>
	            <button id="delay-100" class="btn-gray" onclick="setDelay(100)">高速(0.1s:2s)</button>
                <button id="delay-200" class="btn-gray" onclick="setDelay(200)">低速(0.2s:4s)</button>
            </div>

        </div>
        
        <div id="anim-controls">
            <div class="btn-group">
                <button class="btn-blue" onclick="document.getElementById('bulk-upload').click()">複数PNG読込</button>
                <button class="btn-blue" onclick="document.getElementById('apng-import').click()">1APNG読込</button>
                <button class="btn-orange" onclick="exportSingleAPNG()">1APNG保存</button>
                <button class="btn-green" onclick="smartFill()">空フレーム充填</button>
            </div>
        </div>
        
        <div id="tab-controls" style="display:none; text-align:center;">
            <button class="btn-blue" style="padding:10px 20px" onclick="document.getElementById('file-0').click()">PNG読込</button>
        </div>

        <input type="file" id="bulk-upload" multiple accept="image/*" style="display:none" onchange="handleBulkUpload(this)">
        <input type="file" id="apng-import" accept="image/png" style="display:none" onchange="handleApngImport(this)">
        <input type="file" id="file-0" accept="image/*" onchange="loadSingle(0, this)" style="display:none">
    </div>
    
    <div id="frames-list" style="margin-top:10px;"></div>
</div>

<script src="project-manager.js"></script>
<script src="editor-logic.js"></script>

<script>
    const toggleLoading = (show, text = "処理中...") => {
        const el = document.getElementById('loading-screen');
        const txt = document.getElementById('loading-text');
        if(txt) txt.innerText = text;
        if(el) el.style.display = show ? 'flex' : 'none';
    };

    function saveBlob(b, n) { 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(b); 
        a.download = n; 
        a.click(); 
    }
</script>

</body>
</html>
